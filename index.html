<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITALIANA Bestellrechner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #8b5cf6;
            --accent: #06d6a0;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
        }

        .dark {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --secondary: #a78bfa;
            --accent: #34d399;
            --background: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #e2e8f0 100%);
            color: var(--text);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .dark body {
            background: linear-gradient(135deg, var(--background) 0%, #1e293b 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark .glass-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .category-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .item-card {
            background: transparent;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .item-card:hover {
            background: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.1);
        }

        .dark .item-card:hover {
            background: rgba(96, 165, 250, 0.05);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            border-radius: 12px;
            overflow: hidden;
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark .quantity-control {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quantity-control button {
            background: transparent;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            color: var(--primary);
            transition: all 0.2s ease;
        }

        .quantity-control button:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .quantity-control input {
            width: 50px;
            text-align: center;
            background: transparent;
            border: none;
            padding: 8px 4px;
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
        }

        .result-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
    </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-50 transition-colors duration-300">
    <div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
        <div class="glass-card rounded-3xl p-6 w-full max-w-7xl mx-auto fade-in">
            <!-- Header -->
            <div class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <img id="headerImage" src="https://via.placeholder.com/80" alt="Restaurant Logo" class="rounded-2xl shadow-lg w-20 h-20 object-cover">
                        <div class="absolute inset-0 rounded-2xl border-2 border-white/20"></div>
                    </div>
                    <div>
                        <h1 id="calculatorTitle" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">ITALIANA</h1>
                        <p class="text-gray-600 dark:text-gray-400">Bestellrechner</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="btn btn-secondary">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <!-- Settings Button -->
                    <button onclick="openSettings()" class="btn btn-secondary">
                        <i class="fas fa-cog"></i>
                    </button>

                    <!-- Reset Button -->
                    <button onclick="resetRechner()" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                        Reset
                    </button>
                </div>
            </div>

            <!-- Categories Grid -->
            <div id="categoriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
                <!-- Categories will be dynamically inserted here -->
            </div>

            <!-- Results Card -->
            <div class="result-card p-6 mb-6 fade-in">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-white/90">Bestellübersicht</h3>
                        <p class="text-white/70 text-sm">Aktuelle Berechnung</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyText('grund')" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition-colors" title="Bestelltext kopieren">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="copyPriceText()" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition-colors" title="Preis kopieren">
                            <i class="fas fa-dollar-sign"></i>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-white/80 text-sm font-medium mb-2">Bestelltext:</p>
                        <div id="grund" class="text-white text-lg font-semibold bg-white/10 p-3 rounded-xl">Noch nichts berechnet</div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-white/20">
                        <span class="text-white/80 text-lg font-medium">Gesamtpreis:</span>
                        <span id="preis" class="text-3xl font-bold text-white">0$</span>
                    </div>
                </div>
            </div>

            <!-- Success Message -->
            <div id="kopiertHinweis" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300 transform translate-x-full">
                <div class="flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    <span>Kopiert!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Einstellungen</h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="passwordSection">
                <div class="mb-4">
                    <label for="passwordInput" class="block text-sm font-medium mb-2">Passwort:</label>
                    <input type="password" id="passwordInput" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100" placeholder="Passwort eingeben">
                </div>
                <button onclick="checkPassword()" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    Anmelden
                </button>
                <p id="passwordError" class="text-red-500 text-sm mt-2 hidden text-center">
                    <i class="fas fa-exclamation-triangle"></i> Falsches Passwort!
                </p>
            </div>

            <div id="editSection" class="hidden">
                <div class="flex gap-2 mb-6 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl">
                    <button class="flex-1 py-2 px-4 rounded-lg transition-all settings-tab active" onclick="showEditor('item')">Artikel</button>
                    <button class="flex-1 py-2 px-4 rounded-lg transition-all settings-tab" onclick="showEditor('category')">Kategorien</button>
                    <button class="flex-1 py-2 px-4 rounded-lg transition-all settings-tab" onclick="showEditor('general')">Allgemein</button>
                </div>

                <div id="itemEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-4">Artikel bearbeiten</h4>
                    <div id="itemEditorContent"></div>
                </div>

                <div id="categoryEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-4">Kategorien bearbeiten</h4>
                    <div id="categoryEditorContent" class="space-y-4 mb-6"></div>
                    <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
                        <h5 class="font-semibold mb-3">Neue Kategorie:</h5>
                        <input type="text" id="categoryName" placeholder="Kategoriename" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-3">
                        <button onclick="saveCategory()" class="btn btn-primary w-full">
                            <i class="fas fa-plus"></i>
                            Hinzufügen
                        </button>
                    </div>
                </div>
                
                <div id="generalSettingsEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-4">Allgemeine Einstellungen</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="titleInput" class="block text-sm font-medium mb-2">Titel:</label>
                            <input type="text" id="titleInput" placeholder="Restaurant Name" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="imageUpload" class="block text-sm font-medium mb-2">Logo:</label>
                            <input type="file" id="imageUpload" accept="image/*" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                        </div>
                        <button onclick="saveGeneralSettings()" class="btn btn-primary w-full">
                            <i class="fas fa-save"></i>
                            Speichern
                        </button>
                        <button onclick="resetImage()" class="btn btn-danger w-full">
                            <i class="fas fa-undo"></i>
                            Logo zurücksetzen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Konfiguration
        tailwind.config = {
            darkMode: 'class',
        }

        // API-Konfiguration
        const JSONBIN_MASTER_KEY = '$2a$10$XucE.nX.IQOHF.VOBmrgbOunJNhPV3Mu4L1XeqvWmW8iYWoYe2Y3a';
        const JSONBIN_BIN_ID = '68ed7d3443b1c97be9665d9e';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        const JSONBIN_HEADERS = {
            'X-Master-Key': JSONBIN_MASTER_KEY,
            'Content-Type': 'application/json',
            'X-Bin-Versioning': 'false'
        };

        const ENCODED_PASSWORD = "S1JDLTA4MTU=";
        
        // Standardpreise
        const defaultPreise = {
            beluga: { name: 'Beluga Kaviar', price: 300, category: 'SPEISEN', id: 'beluga' },
            doener: { name: 'Fischdöner', price: 175, category: 'SPEISEN', id: 'doener' },
            bowl: { name: 'Seafood Bowl', price: 175, category: 'SPEISEN', id: 'bowl' },
            lobster: { name: 'Lobster Teller', price: 175, category: 'SPEISEN', id: 'lobster' },
            lachs: { name: 'Lachsnudeln', price: 140, category: 'SPEISEN', id: 'lachs' },
            fiji: { name: 'Fiji Wasser', price: 75, category: 'GETRÄNKE', id: 'fiji' },
            eistee: { name: 'Eistee Pfirsich', price: 75, category: 'GETRÄNKE', id: 'eistee' },
            slush: { name: 'Lake Slush', price: 75, category: 'GETRÄNKE', id: 'slush' },
            mojito: { name: 'Lake Mojito', price: 60, category: 'GETRÄNKE', id: 'mojito' },
            cola: { name: 'Cola Cherry', price: 60, category: 'GETRÄNKE', id: 'cola' },
            dom: { name: 'Dom Perignon', price: 400, category: 'ALKOHOL', id: 'dom' },
            jacky: { name: 'Jacky Cola', price: 300, category: 'ALKOHOL', id: 'jacky' },
            raki: { name: 'Yeni Raki', price: 200, category: 'ALKOHOL', id: 'raki' },
            kuchen: { name: 'Kuchen', price: 400, category: 'DESSERTS', id: 'kuchen' },
            pudding: { name: 'Pudding', price: 300, category: 'DESSERTS', id: 'pudding' },
            kekse: { name: 'Kekse', price: 300, category: 'DESSERTS', id: 'kekse' },
            rose: { name: 'Ecla Lune Rose 1L', price: 10000, category: 'PREMIUM', id: 'rose' },
            gold: { name: 'Ecla Lune Gold 6L', price: 35000, category: 'PREMIUM', id: 'gold' },
            gutschein: { name: 'Essens Gutschein', price: 1500, category: 'PREMIUM', id: 'gutschein' },
            vape: { name: 'Vape', price: 100, category: 'RAUCHWAREN', id: 'vape' }
        };

        // Globale Variablen
        let currentPreise = {};
        let categories = ['SPEISEN', 'GETRÄNKE', 'ALKOHOL', 'DESSERTS', 'PREMIUM', 'RAUCHWAREN'];
        let customTitle = 'ITALIANA';
        let customImage = 'https://via.placeholder.com/80';
        const DEFAULT_IMAGE_URL = 'https://via.placeholder.com/80';

        // Hilfsfunktionen
        function decodeBase64(str) {
            return atob(str);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Daten laden und speichern
        async function loadPreise() {
            showLoading();
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.record) {
                    currentPreise = data.record.items || { ...defaultPreise };
                    categories = data.record.categories || Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                    customTitle = data.record.title || 'ITALIANA';
                    customImage = data.record.image || DEFAULT_IMAGE_URL;
                    console.log("Daten erfolgreich vom Server geladen.");
                } else {
                    console.warn("Serverdaten leer oder im falschen Format. Lade Standardwerte.");
                    currentPreise = { ...defaultPreise };
                    categories = Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                    customTitle = 'ITALIANA';
                    customImage = DEFAULT_IMAGE_URL;
                }
            } catch (error) {
                console.error("Fehler beim Laden der Daten vom Server:", error);
                currentPreise = { ...defaultPreise };
                categories = Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                customTitle = 'ITALIANA';
                customImage = DEFAULT_IMAGE_URL;
            } finally {
                hideLoading();
                renderCalculatorInputs();
                updateGeneralSettingsDisplay();
            }
        }

        async function savePreise() {
            showLoading();
            try {
                const dataToSave = {
                    items: currentPreise,
                    categories: categories,
                    title: customTitle,
                    image: customImage
                };
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: JSONBIN_HEADERS,
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                console.log("Daten erfolgreich auf dem Server gespeichert.");
            } catch (error) {
                console.error("Fehler beim Speichern der Daten auf dem Server:", error);
                alert("Fehler beim Speichern der Daten. Bitte versuchen Sie es erneut.");
            } finally {
                hideLoading();
            }
        }
        
        function updateGeneralSettingsDisplay() {
            document.getElementById('calculatorTitle').innerText = customTitle;
            document.getElementById('headerImage').src = customImage;
        }

        // UI Rendering
        function renderCalculatorInputs() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';
            
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-card p-6 fade-in';
                categoryDiv.innerHTML = `
                    <h2 class="category-header text-xl font-bold mb-4 text-center">${category.toUpperCase()}</h2>
                    <div class="space-y-3"></div>
                `;
                categoriesGrid.appendChild(categoryDiv);

                const itemsDiv = categoryDiv.querySelector('.space-y-3');
                const itemsInCategory = Object.values(currentPreise).filter(item => item.category === category);

                if (itemsInCategory.length === 0) {
                    itemsDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Keine Artikel</p>';
                } else {
                    itemsInCategory.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'item-card';
                        div.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-1 min-w-0 mr-4">
                                    <div class="font-medium text-gray-800 dark:text-gray-200 truncate">${item.name}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400 font-semibold">${item.price}$</div>
                                </div>
                                <div class="quantity-control">
                                    <button onclick="changeQuantity('${item.id}', -1)" class="hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input id="${item.id}" type="number" min="0" value="0" oninput="berechne()" class="font-mono">
                                    <button onclick="changeQuantity('${item.id}', 1)" class="hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        itemsDiv.appendChild(div);
                    });
                }
            });
        }
        
        function changeQuantity(id, change) {
            const input = document.getElementById(id);
            if (input) {
                let currentValue = parseInt(input.value) || 0;
                currentValue += change;
                if (currentValue < 0) {
                    currentValue = 0;
                }
                input.value = currentValue;
                berechne();
            }
        }

        // Berechnungslogik
        function berechne() {
            let summe = 0;
            const orderedItems = [];
            
            for (const key in currentPreise) {
                const inputElement = document.getElementById(key);
                if (inputElement) {
                    const anzahl = parseInt(inputElement.value) || 0;
                    if (anzahl > 0) {
                        summe += anzahl * currentPreise[key].price;
                        orderedItems.push(`${anzahl}x ${currentPreise[key].name}`);
                    }
                }
            }

            document.getElementById("preis").innerText = `${summe}$`;

            let grund = '';
            
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const dateString = `${day}.${month}.`;

            if (orderedItems.length > 0) {
                grund = `KL | ${dateString} | ${orderedItems.join(' + ')}`;
            } else {
                grund = "Noch nichts berechnet";
            }
            
            document.getElementById("grund").innerText = grund;
        }

        // Copy-Funktionen
        function copyText(id) {
            const textToCopy = document.getElementById(id).innerText;
            copyToClipboard(textToCopy);
        }

        function copyPriceText() {
            const priceText = document.getElementById('preis').innerText;
            const textToCopy = priceText.replace('$', '');
            copyToClipboard(textToCopy);
        }

        function copyToClipboard(textToCopy) {
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            tempInput.style.position = 'absolute';
            tempInput.style.left = '-9999px';
            tempInput.style.top = '0';
            document.body.appendChild(tempInput);

            tempInput.select();
            tempInput.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showCopyNotification();
            } catch (err) {
                console.error('Kopieren fehlgeschlagen: ', err);
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        function showCopyNotification() {
            const hinweis = document.getElementById("kopiertHinweis");
            hinweis.classList.remove("translate-x-full");
            setTimeout(() => {
                hinweis.classList.add("translate-x-full");
            }, 2000);
        }

        // Theme-Funktionen
        function toggleTheme() {
            const htmlElement = document.documentElement;
            const isDarkMode = htmlElement.classList.toggle("dark");
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeButton();
        }

        function updateThemeButton() {
            const themeToggle = document.getElementById('themeToggle');
            const icon = themeToggle.querySelector('i');
            if (document.documentElement.classList.contains('dark')) {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        function resetRechner() {
            const inputs = document.querySelectorAll('#categoriesGrid input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;
            });
            document.getElementById("grund").innerText = "Noch nichts berechnet";
            document.getElementById("preis").innerText = "0$";
        }

        // Settings / Admin Panel Funktionen
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            loadPreise();
        }

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');

            const DECODED_PASSWORD = decodeBase64(ENCODED_PASSWORD);

            if (passwordInput.value === DECODED_PASSWORD) {
                passwordError.classList.add('hidden');
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('editSection').classList.remove('hidden');
                showEditor('item');
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        function showEditor(editorType) {
            document.getElementById('itemEditor').classList.add('hidden');
            document.getElementById('categoryEditor').classList.add('hidden');
            document.getElementById('generalSettingsEditor').classList.add('hidden');
            
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-white', 'dark:bg-gray-700', 'shadow-sm');
            });

            const activeTab = document.querySelector(`.settings-tab:nth-child(${editorType === 'item' ? 1 : editorType === 'category' ? 2 : 3})`);
            activeTab.classList.add('active', 'bg-white', 'dark:bg-gray-700', 'shadow-sm');

            if (editorType === 'item') {
                document.getElementById('itemEditor').classList.remove('hidden');
                renderItemEditor();
            } else if (editorType === 'category') {
                document.getElementById('categoryEditor').classList.remove('hidden');
                renderCategoryEditor();
            } else if (editorType === 'general') {
                document.getElementById('generalSettingsEditor').classList.remove('hidden');
                renderGeneralSettingsEditor();
            }
        }

        async function renderItemEditor() {
            await loadPreise();
            const itemEditorDiv = document.getElementById('itemEditorContent');
            itemEditorDiv.innerHTML = '';

            const categorySelect = document.createElement('select');
            categorySelect.id = 'editorCategorySelect';
            categorySelect.className = 'w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-4';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.innerText = cat;
                categorySelect.appendChild(option);
            });
            itemEditorDiv.appendChild(categorySelect);

            const itemsListDiv = document.createElement('div');
            itemsListDiv.id = 'editorItemsList';
            itemsListDiv.className = 'space-y-3 mb-6 max-h-60 overflow-y-auto';
            itemEditorDiv.appendChild(itemsListDiv);

            const itemForm = document.createElement('div');
            itemForm.className = 'border-t border-gray-300 dark:border-gray-600 pt-4';
            itemForm.innerHTML = `
                <h5 class="font-semibold mb-3">Artikel hinzufügen/bearbeiten:</h5>
                <input type="hidden" id="editItemId">
                <div class="space-y-3">
                    <input type="text" id="itemName" placeholder="Artikelname" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                    <input type="number" id="itemPrice" placeholder="Preis" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                </div>
                <button onclick="saveItem()" class="btn btn-primary w-full mt-4">
                    <i class="fas fa-save"></i>
                    Speichern
                </button>
            `;
            itemEditorDiv.appendChild(itemForm);

            categorySelect.addEventListener('change', updateEditorItemsList);
            updateEditorItemsList();
        }

        function updateEditorItemsList() {
            const selectedCategory = document.getElementById('editorCategorySelect').value;
            const itemsListDiv = document.getElementById('editorItemsList');
            itemsListDiv.innerHTML = '';

            const itemsInCategory = Object.values(currentPreise).filter(item => item.category === selectedCategory);

            if (itemsInCategory.length === 0) {
                itemsListDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Keine Artikel in dieser Kategorie.</p>';
            } else {
                itemsInCategory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-xl';
                    div.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-800 dark:text-gray-200">${item.name}</div>
                            <div class="text-sm text-blue-600 dark:text-blue-400">${item.price}$</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editItem('${item.id}')" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('${item.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    itemsListDiv.appendChild(div);
                });
            }
        }

        async function saveItem() {
            const itemId = document.getElementById('editItemId').value;
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseInt(document.getElementById('itemPrice').value);
            const itemCategory = document.getElementById('editorCategorySelect').value;

            if (!itemName || isNaN(itemPrice) || itemPrice <= 0) {
                alert('Bitte gültigen Namen und Preis eingeben.');
                return;
            }

            if (itemId && currentPreise[itemId]) {
                currentPreise[itemId].name = itemName;
                currentPreise[itemId].price = itemPrice;
                currentPreise[itemId].category = itemCategory;
            } else {
                const newId = 'item_' + Date.now();
                currentPreise[newId] = {
                    id: newId,
                    name: itemName,
                    price: itemPrice,
                    category: itemCategory
                };
            }

            await savePreise();
            updateEditorItemsList();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
            renderCalculatorInputs();
        }

        function editItem(id) {
            const item = currentPreise[id];
            if (item) {
                document.getElementById('editItemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('editorCategorySelect').value = item.category;
                document.getElementById('itemName').focus();
            }
        }

        async function deleteItem(id) {
            if (confirm(`Sicher, dass du "${currentPreise[id].name}" löschen möchtest?`)) {
                delete currentPreise[id];
                await savePreise();
                updateEditorItemsList();
                renderCalculatorInputs();
            }
        }
        
        // Category Editor Functions
        function renderCategoryEditor() {
            const categoryEditorDiv = document.getElementById('categoryEditorContent');
            categoryEditorDiv.innerHTML = '';

            const categoryListDiv = document.createElement('div');
            categoryListDiv.className = 'space-y-3 mb-6';
            categoryEditorDiv.appendChild(categoryListDiv);

            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-xl';
                div.innerHTML = `
                    <span class="font-medium text-gray-800 dark:text-gray-200">${cat}</span>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${cat}')" class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory('${cat}')" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                categoryListDiv.appendChild(div);
            });
        }

        async function saveCategory() {
            const categoryName = document.getElementById('categoryName').value.trim().toUpperCase();
            if (!categoryName) {
                alert('Bitte geben Sie einen Kategorienamen ein.');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('Diese Kategorie existiert bereits.');
                return;
            }

            categories.push(categoryName);
            await savePreise();
            renderCategoryEditor();
            document.getElementById('categoryName').value = '';
            renderCalculatorInputs();
        }

        async function editCategory(oldName) {
            const newName = prompt(`Neuen Namen für die Kategorie "${oldName}" eingeben:`, oldName);
            if (newName === null || newName.trim() === '') {
                return;
            }
            const trimmedNewName = newName.trim().toUpperCase();
            
            if (trimmedNewName === oldName) return;

            if (categories.includes(trimmedNewName)) {
                 alert('Eine Kategorie mit diesem Namen existiert bereits.');
                 return;
            }

            for (const itemId in currentPreise) {
                if (currentPreise[itemId].category === oldName) {
                    currentPreise[itemId].category = trimmedNewName;
                }
            }

            const index = categories.indexOf(oldName);
            if (index > -1) {
                categories[index] = trimmedNewName;
            }

            await savePreise();
            renderCategoryEditor();
            renderCalculatorInputs();
        }

        async function deleteCategory(categoryName) {
            const itemsInCategory = Object.values(currentPreise).filter(item => item.category === categoryName);
            if (itemsInCategory.length > 0) {
                alert(`Die Kategorie "${categoryName}" enthält noch Artikel und kann nicht gelöscht werden. Bitte löschen oder verschieben Sie die Artikel zuerst.`);
                return;
            }
            if (confirm(`Sicher, dass du die Kategorie "${categoryName}" löschen möchtest?`)) {
                categories = categories.filter(cat => cat !== categoryName);
                await savePreise();
                renderCategoryEditor();
                renderCalculatorInputs();
            }
        }
        
        // General Settings Functions
        function renderGeneralSettingsEditor() {
            document.getElementById('titleInput').value = customTitle;
        }

        async function saveGeneralSettings() {
            const newTitle = document.getElementById('titleInput').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (newTitle) {
                customTitle = newTitle;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 80;
                        canvas.height = 80;
                        ctx.drawImage(img, 0, 0, 80, 80);
                        customImage = canvas.toDataURL(imageFile.type);
                        await savePreise();
                        updateGeneralSettingsDisplay();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(imageFile);
            } else {
                await savePreise();
                updateGeneralSettingsDisplay();
            }
        }

        async function resetImage() {
            if (confirm('Sicher, dass Sie das Logo zurücksetzen möchten?')) {
                customImage = DEFAULT_IMAGE_URL;
                await savePreise();
                updateGeneralSettingsDisplay();
            }
        }
        
        // Initialisierung
        window.onload = async function() {
            // Theme einrichten
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeButton();

            // Event Listener für Theme Toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Daten laden
            await loadPreise();
            berechne();
        };
    </script>
</body>
</html>
