<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="htmlTitle">KhusLand Bestellrechner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: auto;
            background-color: #f0f0f0;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark {
            background-color: #1a202c;
            color: #f7fafc;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #grund {
            white-space: pre-wrap;
            word-break: break-word;
            overflow-x: auto;
        }
        /* Style f√ºr Tabs Container */
        .tabs-container {
            position: relative;
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            margin-top: 0.5rem;
            margin-left: 0.5rem;
        }
        /* Style f√ºr Tab-Buttons */
        .tab-button {
            position: relative;
            z-index: 10;
            @apply px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200 border border-gray-300 dark:border-gray-600;
            background-color: transparent;
            color: inherit;
        }
        /* Style f√ºr den Slider selbst */
        .tabs-slider {
            position: absolute;
            height: 100%;
            width: var(--tab-width, 0px);
            left: var(--tab-left, 0px);
            border-radius: 0.5rem;
            background-color: #3b82f6;
            transition: left 0.3s ease, width 0.3s ease, background-color 0.3s ease;
            z-index: 5;
        }
        body.dark .tabs-slider {
            background-color: #1d4ed8;
        }
        /* Textfarbe f√ºr aktive Tabs √ºber dem Slider */
        .tab-button.active {
            color: white;
        }
        /* Settings Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            color: #333;
        }
        body.dark .modal-content {
            background-color: #2d3748;
            color: #f7fafc;
        }
        /* Loading Spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* NEUE CSS F√úR QUANTITY CONTROL */
        .quantity-control {
            display: flex;
            align-items: center;
            border-radius: 0.375rem;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #e5e7eb; /* Light gray background */
            flex-shrink: 0; 
        }
        body.dark .quantity-control {
            background-color: #4B5563; /* Darker background for the entire control in dark mode */
        }
        .quantity-control button {
            background-color: transparent; /* Remove background from button */
            border: none;
            padding: 0.5rem 0.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            color: #4B5563; /* Dark gray text color for buttons */
            transition: background-color 0.2s ease, color 0.2s ease;
            outline: none;
        }
        .quantity-control button:hover {
            background-color: #d1d5db; /* Lighter gray on hover */
        }
        body.dark .quantity-control button {
            color: #d1d5db; /* Light gray text color for buttons in dark mode */
        }
        body.dark .quantity-control button:hover {
            background-color: #6B7280; /* Darker gray on hover in dark mode */
        }
        .quantity-control input {
            width: 3rem;
            text-align: center;
            background-color: #f3f4f6; /* Very light background for input */
            border: none;
            padding: 0.5rem 0.25rem;
            -moz-appearance: textfield;
            color: #1f2937; /* Very dark text color for input */
            outline: none;
        }
        body.dark .quantity-control input {
            background-color: #1f2937; /* Dark background for input in dark mode */
            color: #f7fafc; /* White text color for input in dark mode */
        }
        /* ENDE NEUE CSS */
        
        /* NEUE LAYOUT-REGELN F√úR ARTIKEL-ZEILEN */
        #categoriesGrid .space-y-3 > div {
            display: flex;
            align-items: flex-start; /* Anpassung: Richtet am oberen Rand aus, falls Text umbricht */
            justify-content: space-between;
            gap: 0.5rem;
        }

        #categoriesGrid .space-y-3 > div .item-details {
            flex-grow: 1; /* L√§sst den Container den gesamten verf√ºgbaren Platz einnehmen */
            min-width: 0; /* WICHTIG: Erlaubt dem Flex-Element, kleiner als sein Inhalt zu werden, damit der Text umbricht */
            word-break: break-word; /* Bricht auch extrem lange W√∂rter ohne Leerzeichen um */
        }
        /* ENDE NEUE LAYOUT-REGELN */

        /* NEUE CSS F√úR DROPDOWN (BLEIBT NUR F√úR DIE EINSTELLUNGEN, WENN VORHANDEN) */
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            z-index: 50;
        }
        .dropdown-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px);}
            to { opacity: 1; transform: translateY(0);}
        }
        /* ENDE NEUE CSS */
    </style>
</head>
<body class="dark:bg-gray-900 dark:text-gray-50">
    <div class="px-4 sm:px-6 lg:px-8 pt-4">
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 w-full max-w-6xl relative mx-auto">

            <div class="absolute top-4 right-4 flex items-center space-x-2">
                <label class="text-sm">üåû</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="themeToggle" class="sr-only peer" onchange="toggleTheme()">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300"></span>
                </label>
                <label class="text-sm">üåô</label>
            </div>
            
            <div class="flex justify-between items-center mb-6 relative">
                <div class="flex flex-col items-start flex-1 min-w-0">
                    <h4 class="text-xl font-bold text-left text-blue-600 dark:text-blue-400">Bestellseiten</h4>
                    <div class="tabs-container" id="tabsContainer">
                        <div class="tabs-slider" id="tabsSlider"></div>
                        <button class="tab-button" data-tab="1">1</button>
                        <button class="tab-button" data-tab="2">2</button>
                        <button class="tab-button" data-tab="3">3</button>
                        <button class="tab-button" data-tab="4">4</button>
                        <button class="tab-button" data-tab="5">5</button>
                    </div>
                </div>

                <div class="flex flex-col items-center justify-center flex-1">
                    <img id="headerImage" src="https://via.placeholder.com/150" alt="Header Image" class="rounded-lg shadow-md mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                    <h2 id="calculatorTitle" class="text-3xl font-extrabold text-blue-600 dark:text-blue-400 whitespace-nowrap">üå¥ ITALIANA Bestellrechner üå¥</h2>
                </div>

                <div class="flex-1"></div>
            </div>

            <div id="calculatorContent">
                <div id="categoriesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8 mb-6">
                    </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-4 flex flex-col space-y-2">
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-lg text-gray-800 dark:text-gray-200 flex items-center">
                            Grund:&nbsp;
                            <span id="grund" class="text-base font-normal text-gray-700 dark:text-gray-300">Noch nichts berechnet</span>
                        </div>
                        <button onclick="copyText('grund')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-600 text-2xl focus:outline-none">üìÑ</button>
                    </div>
                    <hr class="my-2 border-gray-300 dark:border-gray-600">
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-lg text-gray-800 dark:text-gray-200 flex items-center">
                            Preis:&nbsp;
                            <span id="preis" class="text-lg font-semibold text-blue-600 dark:text-blue-400">0$</span>
                        </div>
                        <button onclick="copyPriceText()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-600 text-2xl focus:outline-none">üìÑ</button>
                    </div>
                </div>

            </div><div id="kopiertHinweis" class="text-sm text-green-600 dark:text-green-400 text-center hidden mt-4">Kopiert ‚úÖ</div>

            <div class="flex justify-between items-center mt-6">
                <button onclick="openSettings()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    ‚öôÔ∏è
                </button>
                
                <div class="flex items-center">
                    <label class="text-sm font-bold text-gray-800 dark:text-gray-200 mr-2 whitespace-nowrap">Personen:</label>
                    <div class="quantity-control">
                        <button onclick="changeQuantity('personCountInput', -1)">-</button>
                        <input id="personCountInput" type="number" min="0" value="0" oninput="berechne()">
                        <button onclick="changeQuantity('personCountInput', 1)">+</button>
                    </div>
                </div>

                <button onclick="resetRechner()" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                    Reset üóëÔ∏è
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">Einstellungen</h3>
            <div id="passwordSection">
                <label for="passwordInput" class="block text-sm font-medium mb-2">Passwort:</label>
                <input type="password" id="passwordInput" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                <button onclick="checkPassword()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Anmelden</button>
                <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Falsches Passwort!</p>
            </div>
            <div id="editSection" class="hidden">
                <div class="tabs flex justify-around mb-4">
                    <button class="px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent hover:border-blue-500 dark:hover:border-blue-300" onclick="showEditor('item')">Artikel</button>
                    <button class="px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent hover:border-blue-500 dark:hover:border-blue-300" onclick="showEditor('category')">Kategorien</button>
                    <button class="px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-transparent hover:border-blue-500 dark:hover:border-blue-300" onclick="showEditor('general')">Generelle Einstellungen</button>
                </div>

                <div id="itemEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-3">Artikel bearbeiten</h4>
                    <div id="itemEditorContent"></div>
                </div>

                <div id="categoryEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-3">Kategorien bearbeiten</h4>
                    <div id="categoryEditorContent" class="space-y-3 mb-6"></div>
                    <div class="border-t border-gray-300 dark:border-gray-600 pt-4">
                        <h5 class="font-semibold mb-2">Kategorie hinzuf√ºgen:</h5>
                        <input type="text" id="categoryName" placeholder="Kategoriename" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-2">
                        <button onclick="saveCategory()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Hinzuf√ºgen</button>
                    </div>
                </div>
                
                <div id="generalSettingsEditor" class="hidden">
                    <h4 class="text-lg font-bold mb-3">Generelle Einstellungen</h4>
                    <div class="mb-4">
                        <label for="titleInput" class="block text-sm font-medium mb-2">Titel √§ndern:</label>
                        <input type="text" id="titleInput" placeholder="Neuer Titel" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                    </div>
                    <div class="mb-4">
                        <label for="imageUpload" class="block text-sm font-medium mb-2">Bild hochladen (wird auf 150x150px skaliert):</label>
                        <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100">
                    </div>
                    <button onclick="saveGeneralSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Speichern</button>
                    <button onclick="resetImage()" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Bild zur√ºcksetzen</button>
                </div>

                <button onclick="closeSettings()" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Schlie√üen</button>
            </div>
            <button onclick="closeSettings()" class="mt-4 px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 rounded-lg float-right">X</button>
        </div>
    </div>

    <div id="loadingOverlay" class="modal-overlay hidden">
        <div class="loading-spinner"></div>
    </div>


    <script>
        tailwind.config = {
            darkMode: 'class',
        }

        // !!! ERSETZE DIES MIT DEINEN EIGENEN WERTEN VON JSONBIN.IO !!!
        const JSONBIN_MASTER_KEY = '$2a$10$szNDzN.Y6Xwin9HEcbhi/O70xfGZCaX/Kcb8a5lLCCSObE/XysMbq';
        const JSONBIN_BIN_ID = '68ed40d843b1c97be9661a9b';
        // !!! SICHERHEITSHINWEIS: API-Keys im Frontend sind nicht sicher f√ºr Produktion !!!

        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        const JSONBIN_HEADERS = {
            'X-Master-Key': JSONBIN_MASTER_KEY,
            'Content-Type': 'application/json',
            'X-Bin-Versioning': 'false'
        };

        const ENCODED_PASSWORD = "S1JDLTA4MTU=";
        
        function decodeBase64(str) {
            // Die atob-Funktion dekodiert Base64 in JavaScript
            if (typeof window !== 'undefined' && typeof atob === 'function') {
                return atob(str);
            }
            // Fallback f√ºr Nicht-Browser-Umgebungen (hier unwahrscheinlich)
            return ''; 
        }

        const defaultPreise = {
            beluga: { name: 'Beluga Kaviar', price: 300, category: 'SPEISEN', id: 'beluga' },
            doener: { name: 'Fischd√∂ner', price: 175, category: 'SPEISEN', id: 'doener' },
            bowl: { name: 'Seafood Bowl', price: 175, category: 'SPEISEN', id: 'bowl' },
            lobster: { name: 'Lobster Teller', price: 175, category: 'SPEISEN', id: 'lobster' },
            lachs: { name: 'Lachsnudeln', price: 140, category: 'SPEISEN', id: 'lachs' },
            fiji: { name: 'Fiji Wasser', price: 75, category: 'GETR√ÑNKE', id: 'fiji' },
            eistee: { name: 'Eistee Pfirsich', price: 75, category: 'GETR√ÑNKE', id: 'eistee' },
            slush: { name: 'Lake Slush', price: 75, category: 'GETR√ÑNKE', id: 'slush' },
            mojito: { name: 'Lake Mojito', price: 60, category: 'GETR√ÑNKE', id: 'mojito' },
            cola: { name: 'Cola Cherry', price: 60, category: 'GETR√ÑNKE', id: 'cola' },
            dom: { name: 'Dom Perignon', price: 400, category: 'ALKOHOL', id: 'dom' },
            jacky: { name: 'Jacky Cola', price: 300, category: 'ALKOHOL', id: 'jacky' },
            raki: { name: 'Yeni Raki', price: 200, category: 'ALKOHOL', id: 'raki' },
            kuchen: { name: 'Kuchen', price: 400, category: 'DESSERTS', id: 'kuchen' },
            pudding: { name: 'Pudding', price: 300, category: 'DESSERTS', id: 'pudding' },
            kekse: { name: 'Kekse', price: 300, category: 'DESSERTS', id: 'kekse' },
            rose: { name: 'Ecla Lune Rose 1L', price: 10000, category: 'PREMIUM', id: 'rose' },
            gold: { name: 'Ecla Lune Gold 6L', price: 35000, category: 'PREMIUM', id: 'gold' },
            gutschein: { name: 'Essens Gutschein', price: 1500, category: 'PREMIUM', id: 'gutschein' },
            vape: { name: 'Vape', price: 100, category: 'RAUCHWAREN', id: 'vape' }
        };

        let currentPreise = {};
        let categories = ['SPEISEN', 'GETR√ÑNKE', 'ALKOHOL', 'DESSERTS', 'PREMIUM', 'RAUCHWAREN'];
        let foodCategories = ['SPEISEN', 'DESSERTS']; 
        let drinkCategories = ['GETR√ÑNKE', 'ALKOHOL'];
        let rauchwarenCategories = ['RAUCHWAREN'];
        let miscellaneousCategories = ['PREMIUM'];
        let customTitle = 'üå¥ ITALIANA Bestellrechner üå¥';
        let customImage = 'https://via.placeholder.com/150';
        const itemsPerPerson = 5;
        const numTabs = 5;
        let activeTab = 1;
        let calculatorStates = {};

        const DEFAULT_IMAGE_URL = 'https://via.placeholder.com/150';

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function loadPreise() {
            showLoading();
            try {
                const response = await fetch(JSONBIN_URL, {
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.record) {
                    currentPreise = data.record.items || { ...defaultPreise };
                    categories = data.record.categories || Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                    foodCategories = data.record.foodCategories || ['SPEISEN', 'DESSERTS'];
                    drinkCategories = data.record.drinkCategories || ['GETR√ÑNKE', 'ALKOHOL'];
                    rauchwarenCategories = data.record.rauchwarenCategories || ['RAUCHWAREN'];
                    miscellaneousCategories = data.record.miscellaneousCategories || ['PREMIUM'];
                    customTitle = data.record.title || 'üå¥ ITALIANA Bestellrechner üå¥';
                    customImage = data.record.image || DEFAULT_IMAGE_URL;
                    console.log("Preise und Kategorien erfolgreich vom Server geladen.");
                } else {
                    console.warn("Serverdaten leer oder im falschen Format. Lade Standardpreise.");
                    currentPreise = { ...defaultPreise };
                    categories = Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                    foodCategories = ['SPEISEN', 'DESSERTS'];
                    drinkCategories = ['GETR√ÑNKE', 'ALKOHOL'];
                    rauchwarenCategories = ['RAUCHWAREN'];
                    miscellaneousCategories = ['PREMIUM'];
                    customTitle = 'üå¥ ITALIANA Bestellrechner üå¥';
                    customImage = DEFAULT_IMAGE_URL;
                }
            } catch (error) {
                console.error("Fehler beim Laden der Preise vom Server:", error);
                alert("Fehler beim Laden der Artikeldaten. Lade Standardwerte. Bitte pr√ºfen Sie Ihre Internetverbindung oder die API-Einstellungen.");
                currentPreise = { ...defaultPreise };
                categories = Object.values(defaultPreise).map(item => item.category).filter((value, index, self) => self.indexOf(value) === index);
                foodCategories = ['SPEISEN', 'DESSERTS'];
                drinkCategories = ['GETR√ÑNKE', 'ALKOHOL'];
                rauchwarenCategories = ['RAUCHWAREN'];
                miscellaneousCategories = ['PREMIUM'];
                customTitle = 'üå¥ ITALIANA Bestellrechner üå¥';
                customImage = DEFAULT_IMAGE_URL;
            } finally {
                hideLoading();
                renderCalculatorInputs();
                updateGeneralSettingsDisplay();
            }
        }

        async function savePreise() {
            showLoading();
            try {
                const dataToSave = {
                    items: currentPreise,
                    categories: categories,
                    foodCategories: foodCategories,
                    drinkCategories: drinkCategories,
                    rauchwarenCategories: rauchwarenCategories,
                    miscellaneousCategories: miscellaneousCategories,
                    title: customTitle,
                    image: customImage
                };
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: JSONBIN_HEADERS,
                    body: JSON.stringify(dataToSave)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Preise und Kategorien erfolgreich auf dem Server gespeichert:", data);
            } catch (error) {
                console.error("Fehler beim Speichern der Preise auf dem Server:", error);
                alert("Fehler beim Speichern der Artikeldaten. Bitte versuchen Sie es erneut oder pr√ºfen Sie die API-Einstellungen.");
            } finally {
                hideLoading();
            }
        }
        
        function updateGeneralSettingsDisplay() {
            document.getElementById('htmlTitle').innerText = customTitle;
            document.getElementById('calculatorTitle').innerText = customTitle;
            document.getElementById('headerImage').src = customImage;
        }

        function renderCalculatorInputs() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            categoriesGrid.innerHTML = '';
            
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.id = `category-${category.replace(/\s/g, '-')}`;
                categoryDiv.innerHTML = `
                    <h1 class="text-xl font-bold mb-4 text-center text-red-700 dark:text-red-400">${category.toUpperCase()}</h1>
                    <div class="space-y-3"></div>
                `;
                categoriesGrid.appendChild(categoryDiv);

                const itemsDiv = categoryDiv.querySelector('.space-y-3');
                const itemsInCategory = Object.values(currentPreise).filter(item => item.category === category);

                itemsInCategory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between';
                    div.innerHTML = `
                        <div class="flex flex-col items-start item-details"> 
                            <label for="${item.id}" class="text-gray-700 dark:text-gray-300">${item.name}</label>
                            <span class="text-sm text-gray-500 dark:text-gray-400">${item.price}$</span>
                        </div>
                        <div class="quantity-control">
                            <button onclick="changeQuantity('${item.id}', -1)">-</button>
                            <input id="${item.id}" type="number" min="0" value="0" oninput="berechne()">
                            <button onclick="changeQuantity('${item.id}', 1)">+</button>
                        </div>
                    `;
                    itemsDiv.appendChild(div);
                });
            });
        }
        
        function changeQuantity(id, change) {
            const input = document.getElementById(id);
            if (input) {
                let currentValue = parseInt(input.value) || 0;
                currentValue += change;
                if (currentValue < 0) {
                    currentValue = 0;
                }
                input.value = currentValue;
                berechne();
            }
        }

        function initializeCalculatorStates() {
            for (let i = 1; i <= numTabs; i++) {
                calculatorStates[i] = {
                    inputs: {},
                    grund: 'Noch nichts berechnet',
                    preis: '0$',
                    personCount: '0'
                };
            }
            const savedStates = localStorage.getItem('calculatorStates');
            if (savedStates) {
                const parsedStates = JSON.parse(savedStates);
                for (const tab in parsedStates) {
                    if (calculatorStates[tab]) {
                        calculatorStates[tab] = parsedStates[tab];
                    }
                }
            }
        }

        function saveCalculatorState() {
            const inputs = document.querySelectorAll('#calculatorContent input[type="number"]');
            const currentState = { inputs: {} };
            inputs.forEach(input => {
                currentState.inputs[input.id] = input.value;
            });
            currentState.grund = document.getElementById('grund').innerText;
            currentState.preis = document.getElementById('preis').innerText;
            currentState.personCount = document.getElementById('personCountInput').value;
            calculatorStates[activeTab] = currentState;
            localStorage.setItem('calculatorStates', JSON.stringify(calculatorStates));
        }

        function loadCalculatorState() {
            const state = calculatorStates[activeTab];
            const inputs = document.querySelectorAll('#calculatorContent input[type="number"]');
            
            inputs.forEach(input => {
                input.value = 0;
            });
            
            if (state) {
                for (const id in state.inputs) {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = state.inputs[id];
                    }
                }
                document.getElementById('grund').innerText = state.grund;
                document.getElementById('preis').innerText = state.preis;
            } else {
                document.getElementById("grund").innerText = "Noch nichts berechnet";
                document.getElementById("preis").innerText = "0$";
            }
            
            // Personenzahl l√§dt separat
            const personCountInput = document.getElementById('personCountInput');
            if (personCountInput && state) {
                personCountInput.value = state.personCount || '0';
            }
        }

        function resetCalculatorInputs() {
            const inputs = document.querySelectorAll('#calculatorContent input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;
            });
            document.getElementById("grund").innerText = "Noch nichts berechnet";
            document.getElementById("preis").innerText = "0$";
        }

        function updateSliderPosition(tabButton) {
            const slider = document.getElementById('tabsSlider');
            const tabsContainer = document.getElementById('tabsContainer');

            tabsContainer.style.position = 'relative';

            if (tabButton && slider) {
                const buttonRect = tabButton.getBoundingClientRect();
                const containerRect = tabsContainer.getBoundingClientRect();

                slider.style.setProperty('--tab-left', `${buttonRect.left - containerRect.left}px`);
                slider.style.setProperty('--tab-width', `${buttonRect.width}px`);
            }
        }

        function switchTab(tabNumber) {
            if (tabNumber === activeTab) return;

            saveCalculatorState();

            document.querySelectorAll(`.tab-button`).forEach(btn => btn.classList.remove('active'));

            const newActiveButton = document.querySelector(`.tab-button[data-tab="${tabNumber}"]`);
            if (newActiveButton) {
                newActiveButton.classList.add('active');
                updateSliderPosition(newActiveButton);
            }

            activeTab = tabNumber;
            loadCalculatorState();
            berechne();
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                switchTab(parseInt(button.dataset.tab));
            });
        });

        function berechne() {
            let summe = 0;
            let foodCount = 0;
            let drinkCount = 0;
            let rauchwarenCount = 0;
            const orderedItems = [];
            const miscellaneousItems = [];
            
            const personCountInput = document.getElementById('personCountInput');
            const manualPersonCount = parseInt(personCountInput.value) || 0;

            for (const key in currentPreise) {
                const inputElement = document.getElementById(key);
                if (inputElement) {
                    const anzahl = parseInt(inputElement.value) || 0;
                    if (anzahl > 0) {
                        summe += anzahl * currentPreise[key].price;
                        const category = currentPreise[key].category;
                        if (foodCategories.includes(category)) {
                            foodCount += anzahl;
                            orderedItems.push(`${anzahl}x ${currentPreise[key].name}`);
                        } else if (drinkCategories.includes(category)) {
                            drinkCount += anzahl;
                            orderedItems.push(`${anzahl}x ${currentPreise[key].name}`);
                        } else if (rauchwarenCategories.includes(category)) {
                            rauchwarenCount += anzahl;
                            orderedItems.push(`${anzahl}x ${currentPreise[key].name}`);
                        } else if (miscellaneousCategories.includes(category)) {
                            miscellaneousItems.push(`${anzahl}x ${currentPreise[key].name}`);
                        }
                    }
                }
            }

            document.getElementById("preis").innerText = `${summe}$`;

            let grund = '';
            
            const totalItems = foodCount + drinkCount + rauchwarenCount + miscellaneousItems.length;
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const dateString = `${day}.${month}.`;

            if (totalItems > 0 || manualPersonCount > 0) {
                
                let grundParts = [`KL | ${dateString}`];
                
                if (manualPersonCount > 0) {
                    grundParts.push(`${manualPersonCount}P`);
                } else {
                    const personCount = Math.max(foodCount, drinkCount) > 0 ? Math.ceil(Math.max(foodCount, drinkCount) / itemsPerPerson) : 0;
                    if (personCount > 0) {
                        grundParts.push(`${personCount}P`);
                    }
                }

                const allOrderedItems = [...orderedItems, ...miscellaneousItems];
                if (allOrderedItems.length > 0) {
                    grundParts.push(allOrderedItems.join(' + '));
                }

                const categories = [];
                if (foodCount > 0) categories.push('Essen');
                if (drinkCount > 0) categories.push('Trinken');
                if (rauchwarenCount > 0) categories.push('Rauchwaren');
                if (categories.length > 0) {
                    grundParts.push(categories.join(' & '));
                }

                grund = grundParts.join(' | ');
            } else {
                grund = "Noch nichts berechnet";
            }
            
            document.getElementById("grund").innerText = grund;
            saveCalculatorState();
        }

        function copyText(id) {
            const textToCopy = document.getElementById(id).innerText;
            copyToClipboard(textToCopy);
        }

        function copyPriceText() {
            const priceText = document.getElementById('preis').innerText;
            const textToCopy = priceText.replace('$', '');
            copyToClipboard(textToCopy);
        }

        function copyToClipboard(textToCopy) {
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            tempInput.style.position = 'absolute';
            tempInput.style.left = '-9999px';
            tempInput.style.top = '0';
            document.body.appendChild(tempInput);

            tempInput.select();
            tempInput.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                const hinweis = document.getElementById("kopiertHinweis");
                if (hinweis) {
                    hinweis.classList.remove("hidden");
                    setTimeout(() => hinweis.classList.add("hidden"), 2000);
                }
            } catch (err) {
                console.error('Kopieren fehlgeschlagen: ', err);
            } finally {
                document.body.removeChild(tempInput);
            }
        }

        function toggleTheme() {
            const htmlElement = document.documentElement;
            const isDarkMode = htmlElement.classList.toggle("dark");
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.body.classList.toggle("dark", isDarkMode);
            const activeTabButton = document.querySelector(`.tab-button[data-tab="${activeTab}"]`);
            if (activeTabButton) {
                updateSliderPosition(activeTabButton);
            }
        }

        function resetRechner() {
            const personCountInput = document.getElementById('personCountInput');
            personCountInput.value = 0;
            resetCalculatorInputs();
            saveCalculatorState();
        }

        // --- Settings / Admin Panel Funktionen ---
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            loadPreise();
        }

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');

            const DECODED_PASSWORD = decodeBase64(ENCODED_PASSWORD);

            if (passwordInput.value === DECODED_PASSWORD) {
                passwordError.classList.add('hidden');
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('editSection').classList.remove('hidden');
                showEditor('item');
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        function showEditor(editorType) {
            document.getElementById('itemEditor').classList.add('hidden');
            document.getElementById('categoryEditor').classList.add('hidden');
            document.getElementById('generalSettingsEditor').classList.add('hidden');
            
            document.querySelectorAll('#editSection .tabs button').forEach(btn => btn.classList.remove('border-blue-500', 'dark:border-blue-300'));

            if (editorType === 'item') {
                document.getElementById('itemEditor').classList.remove('hidden');
                document.querySelector('[onclick="showEditor(\'item\')"]').classList.add('border-blue-500', 'dark:border-blue-300');
                renderItemEditor();
            } else if (editorType === 'category') {
                document.getElementById('categoryEditor').classList.remove('hidden');
                document.querySelector('[onclick="showEditor(\'category\')"]').classList.add('border-blue-500', 'dark:border-blue-300');
                renderCategoryEditor();
            } else if (editorType === 'general') {
                document.getElementById('generalSettingsEditor').classList.remove('hidden');
                document.querySelector('[onclick="showEditor(\'general\')"]').classList.add('border-blue-500', 'dark:border-blue-300');
                renderGeneralSettingsEditor();
            }
        }

        async function renderItemEditor() {
            await loadPreise();
            const itemEditorDiv = document.getElementById('itemEditorContent');
            itemEditorDiv.innerHTML = '';

            const categorySelect = document.createElement('select');
            categorySelect.id = 'editorCategorySelect';
            categorySelect.className = 'w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-4';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.innerText = cat;
                categorySelect.appendChild(option);
            });
            itemEditorDiv.appendChild(categorySelect);

            const itemsListDiv = document.createElement('div');
            itemsListDiv.id = 'editorItemsList';
            itemsListDiv.className = 'space-y-3 mb-6';
            itemEditorDiv.appendChild(itemsListDiv);

            const itemForm = document.createElement('div');
            itemForm.className = 'border-t border-gray-300 dark:border-gray-600 pt-4';
            itemForm.innerHTML = `
                <h5 class="font-semibold mb-2">Artikel hinzuf√ºgen/bearbeiten:</h5>
                <input type="hidden" id="editItemId">
                <input type="text" id="itemName" placeholder="Artikelname" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-2">
                <input type="number" id="itemPrice" placeholder="Preis" class="w-full p-2 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 dark:text-gray-100 mb-2">
                <button onclick="saveItem()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Speichern</button>
            `;
            itemEditorDiv.appendChild(itemForm);

            categorySelect.addEventListener('change', updateEditorItemsList);

            updateEditorItemsList();
        }

        function updateEditorItemsList() {
            const selectedCategory = document.getElementById('editorCategorySelect').value;
            const itemsListDiv = document.getElementById('editorItemsList');
            itemsListDiv.innerHTML = '';

            const itemsInCategory = Object.values(currentPreise).filter(item => item.category === selectedCategory);

            if (itemsInCategory.length === 0) {
                itemsListDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Keine Artikel in dieser Kategorie.</p>';
            } else {
                itemsInCategory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md mb-1';
                    div.innerHTML = `
                        <span class="text-gray-800 dark:text-gray-200">${item.name} (${item.price}$)</span>
                        <div>
                            <button onclick="editItem('${item.id}')" class="text-blue-500 hover:text-blue-700 mr-2">‚úèÔ∏è</button>
                            <button onclick="deleteItem('${item.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                        </div>
                    `;
                    itemsListDiv.appendChild(div);
                });
            }
        }

        async function saveItem() {
            const itemId = document.getElementById('editItemId').value;
            const itemName = document.getElementById('itemName').value.trim();
            const itemPrice = parseInt(document.getElementById('itemPrice').value);
            const itemCategory = document.getElementById('editorCategorySelect').value;

            if (!itemName || isNaN(itemPrice) || itemPrice <= 0) {
                alert('Bitte g√ºltigen Namen und Preis eingeben.');
                return;
            }

            if (itemId && currentPreise[itemId]) {
                currentPreise[itemId].name = itemName;
                currentPreise[itemId].price = itemPrice;
                currentPreise[itemId].category = itemCategory;
            } else {
                const newId = 'item_' + Date.now();
                currentPreise[newId] = {
                    id: newId,
                    name: itemName,
                    price: itemPrice,
                    category: itemCategory
                };
            }

            await savePreise();
            updateEditorItemsList();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('itemPrice').value = '';
        }

        function editItem(id) {
            const item = currentPreise[id];
            if (item) {
                document.getElementById('editItemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('editorCategorySelect').value = item.category;
                document.getElementById('itemName').focus();
            }
        }

        async function deleteItem(id) {
            if (confirm(`Sicher, dass du "${currentPreise[id].name}" l√∂schen m√∂chtest?`)) {
                delete currentPreise[id];
                await savePreise();
                updateEditorItemsList();
            }
        }
        
        // --- Category Editor Functions ---
        function renderCategoryEditor() {
            const categoryEditorDiv = document.getElementById('categoryEditorContent');
            categoryEditorDiv.innerHTML = `
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">W√§hle, welche Kategorien zu Essen, Trinken, Rauchwaren oder Sonstigem z√§hlen.</p>
                <div id="categoryTypeEditor" class="space-y-2 mb-6 border border-gray-300 dark:border-gray-600 p-4 rounded-md"></div>
                <div class="space-y-3 mb-6" id="categoryList"></div>
            `;
            
            const categoryTypeEditorDiv = document.getElementById('categoryTypeEditor');
            categories.forEach(cat => {
                const isFood = foodCategories.includes(cat);
                const isDrink = drinkCategories.includes(cat);
                const isRauchwaren = rauchwarenCategories.includes(cat);
                const isMiscellaneous = miscellaneousCategories.includes(cat);
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between';
                div.innerHTML = `
                    <span class="text-gray-800 dark:text-gray-200 font-semibold">${cat}</span>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-category="${cat}" data-type="food" ${isFood ? 'checked' : ''} onchange="updateCategoryTypes()">
                            <span class="ml-2 text-sm">Essen</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-category="${cat}" data-type="drink" ${isDrink ? 'checked' : ''} onchange="updateCategoryTypes()">
                            <span class="ml-2 -sm">Trinken</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-category="${cat}" data-type="rauchwaren" ${isRauchwaren ? 'checked' : ''} onchange="updateCategoryTypes()">
                            <span class="ml-2 text-sm">Rauchwaren</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" data-category="${cat}" data-type="miscellaneous" ${isMiscellaneous ? 'checked' : ''} onchange="updateCategoryTypes()">
                            <span class="ml-2 text-sm">Sonstiges</span>
                        </label>
                    </div>
                `;
                categoryTypeEditorDiv.appendChild(div);
            });

            const categoryListDiv = document.getElementById('categoryList');
            categories.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md mb-1';
                div.innerHTML = `
                    <span class="text-gray-800 dark:text-gray-200">${cat}</span>
                    <div>
                        <button onclick="editCategory('${cat}')" class="text-blue-500 hover:text-blue-700 mr-2">‚úèÔ∏è</button>
                        <button onclick="deleteCategory('${cat}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </div>
                `;
                categoryListDiv.appendChild(div);
            });
        }
        
        async function updateCategoryTypes() {
            const foodCheckboxes = document.querySelectorAll('input[data-type="food"]');
            const drinkCheckboxes = document.querySelectorAll('input[data-type="drink"]');
            const rauchwarenCheckboxes = document.querySelectorAll('input[data-type="rauchwaren"]');
            const miscellaneousCheckboxes = document.querySelectorAll('input[data-type="miscellaneous"]');

            foodCategories = [];
            drinkCategories = [];
            rauchwarenCategories = [];
            miscellaneousCategories = [];

            foodCheckboxes.forEach(cb => {
                if (cb.checked) {
                    foodCategories.push(cb.dataset.category);
                }
            });

            drinkCheckboxes.forEach(cb => {
                if (cb.checked) {
                    drinkCategories.push(cb.dataset.category);
                }
            });
            
            rauchwarenCheckboxes.forEach(cb => {
                if (cb.checked) {
                    rauchwarenCategories.push(cb.dataset.category);
                }
            });

            miscellaneousCheckboxes.forEach(cb => {
                if (cb.checked) {
                    miscellaneousCategories.push(cb.dataset.category);
                }
            });

            await savePreise();
            berechne();
        }

        async function saveCategory() {
            const categoryName = document.getElementById('categoryName').value.trim().toUpperCase();
            if (!categoryName) {
                alert('Bitte geben Sie einen Kategorienamen ein.');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('Diese Kategorie existiert bereits.');
                return;
            }

            categories.push(categoryName);
            await savePreise();
            renderCategoryEditor();
            document.getElementById('categoryName').value = '';
        }

        async function editCategory(oldName) {
            const newName = prompt(`Neuen Namen f√ºr die Kategorie "${oldName}" eingeben:`);
            if (newName === null || newName.trim() === '') {
                return;
            }
            const trimmedNewName = newName.trim().toUpperCase();
            
            if (trimmedNewName === oldName) return;

            if (categories.includes(trimmedNewName)) {
                 alert('Eine Kategorie mit diesem Namen existiert bereits.');
                 return;
            }

            for (const itemId in currentPreise) {
                if (currentPreise[itemId].category === oldName) {
                    currentPreise[itemId].category = trimmedNewName;
                }
            }

            const index = categories.indexOf(oldName);
            if (index > -1) {
                categories[index] = trimmedNewName;
            }
            
            const foodIndex = foodCategories.indexOf(oldName);
            if (foodIndex > -1) {
                foodCategories[foodIndex] = trimmedNewName;
            }

            const drinkIndex = drinkCategories.indexOf(oldName);
            if (drinkIndex > -1) {
                drinkCategories[drinkIndex] = trimmedNewName;
            }

            const rauchwarenIndex = rauchwarenCategories.indexOf(oldName);
            if (rauchwarenIndex > -1) {
                rauchwarenCategories[rauchwarenIndex] = trimmedNewName;
            }

            const miscellaneousIndex = miscellaneousCategories.indexOf(oldName);
            if (miscellaneousIndex > -1) {
                miscellaneousCategories[miscellaneousIndex] = trimmedNewName;
            }


            await savePreise();
            renderCategoryEditor();
        }

        async function deleteCategory(categoryName) {
            const itemsInCategory = Object.values(currentPreise).filter(item => item.category === categoryName);
            if (itemsInCategory.length > 0) {
                alert(`Die Kategorie "${categoryName}" enth√§lt noch Artikel und kann nicht gel√∂scht werden. Bitte l√∂schen oder verschieben Sie die Artikel zuerst.`);
                return;
            }
            if (confirm(`Sicher, dass du die Kategorie "${categoryName}" l√∂schen m√∂chtest?`)) {
                categories = categories.filter(cat => cat !== categoryName);
                foodCategories = foodCategories.filter(cat => cat !== categoryName);
                drinkCategories = drinkCategories.filter(cat => cat !== categoryName);
                rauchwarenCategories = rauchwarenCategories.filter(cat => cat !== categoryName);
                miscellaneousCategories = miscellaneousCategories.filter(cat => cat !== categoryName);
                await savePreise();
                renderCategoryEditor();
            }
        }
        
        // --- General Settings Functions ---
        function renderGeneralSettingsEditor() {
            document.getElementById('titleInput').value = customTitle;
        }

        async function saveGeneralSettings() {
            const newTitle = document.getElementById('titleInput').value.trim();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (newTitle) {
                customTitle = newTitle;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const img = new Image();
                    img.onload = async function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 150;
                        canvas.height = 150;
                        ctx.drawImage(img, 0, 0, 150, 150);
                        customImage = canvas.toDataURL(imageFile.type);
                        await savePreise();
                        updateGeneralSettingsDisplay();
                        alert('Einstellungen gespeichert!');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(imageFile);
            } else {
                await savePreise();
                updateGeneralSettingsDisplay();
                alert('Einstellungen gespeichert!');
            }
        }

        async function resetImage() {
            if (confirm('Sicher, dass Sie das Bild zur√ºcksetzen m√∂chten?')) {
                customImage = DEFAULT_IMAGE_URL;
                await savePreise();
                updateGeneralSettingsDisplay();
                alert('Bild wurde zur√ºckgesetzt!');
            }
        }
        
        window.onload = async function() {
            await loadPreise();
            initializeCalculatorStates();
            const savedActiveTab = localStorage.getItem('activeTab');
            if (savedActiveTab) {
                activeTab = parseInt(savedActiveTab);
            }

            const initialActiveButton = document.querySelector(`.tab-button[data-tab="${activeTab}"]`);
            if (initialActiveButton) {
                initialActiveButton.classList.add('active');
                updateSliderPosition(initialActiveButton);
            }
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.body.classList.add('dark');
                document.getElementById('themeToggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.remove('dark');
                document.getElementById('themeToggle').checked = false;
            }

            window.addEventListener('resize', () => {
                const currentActiveButton = document.querySelector(`.tab-button[data-tab="${activeTab}"]`);
                if (currentActiveButton) {
                    updateSliderPosition(currentActiveButton);
                }
            });
            
            loadCalculatorState();
        };

        const originalSwitchTab = switchTab;
        switchTab = function(tabNumber) {
            originalSwitchTab(tabNumber);
            localStorage.setItem('activeTab', tabNumber);
        };
    </script>
</body>
</html>
